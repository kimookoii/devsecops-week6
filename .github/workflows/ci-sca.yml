name: CI - SCA & Build (safe/green)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-and-sca:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node (if present)
        uses: actions/setup-node@v4
        with:
          node-version: '18'
        if: files.exists('package.json') || env.FORCE_NODE == 'true'

      - name: Install dependencies (ci if lockfile present, else install)
        shell: bash
        run: |
          if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
            echo "Found lockfile → running npm ci"
            npm ci
          elif [ -f package.json ]; then
            echo "No lockfile but package.json exists → running npm install"
            npm install
          else
            echo "No Node project detected → skipping npm install"
          fi

      - name: Run tests if available
        shell: bash
        run: |
          if [ -f package.json ] && grep -q "\"test\":" package.json; then
            npm test || true
          else
            echo "No test script found or no Node project → skipping tests"
          fi

      - name: Run Snyk test (if SNYK_TOKEN available & package/composer present)
        shell: bash
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          set -e
          FOUND=0
          if [ -f package.json ]; then
            echo "Running Snyk for npm..."
            snyk test --package-manager=npm || FOUND=1
          fi
          if [ -f composer.json ]; then
            echo "Running Snyk for composer..."
            snyk test --file=composer.lock --package-manager=composer || FOUND=1
          fi
          # do not fail the job; record exit code in file for later inspection
          echo $FOUND > snyk_exit_code.txt || true
        continue-on-error: true

      - name: Upload Snyk raw output (if any)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: snyk-exit-code
          path: snyk_exit_code.txt

      - name: Run OWASP Dependency-Check (Docker) if repo has composer.json or package.json
        shell: bash
        run: |
          if [ -f composer.json ] || [ -f package.json ]; then
            mkdir -p reports || true
            docker run --rm -v "${{ github.workspace }}:/src" \
              -v "${{ runner.temp }}/dc-data:/usr/share/dependency-check/data" \
              owasp/dependency-check:latest \
              --scan /src --format "HTML" --out /src/reports || true
            echo "Dependency-Check finished (report in ./reports if generated)"
          else
            echo "No composer.json/package.json detected -> skipping dependency-check"
          fi
        continue-on-error: true

      - name: Upload Dependency-Check report (if exists)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: reports/dependency-check-report.html

      - name: Summary - show artifacts location
        run: |
          echo "Artifacts uploaded. Check Actions run -> Artifacts for reports and Snyk exit status."

